<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLACIAL_ECHO.EXE // TERMINAL 01</title>
    <style>
        :root {
            --bg-color: #050a05;
            --main-color: #33ff33; /* Verde Terminal Clásico */
            --dim-color: #1a801a;
            --alert-color: #ff3333;
            --disabled-color: #333333;
            --scanline-color: rgba(0, 0, 0, 0.5);
            --font-main: 'Courier New', Courier, monospace;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--main-color);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- CRT EFFECT LAYER --- */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0),
                rgba(255, 255, 255, 0) 50%,
                rgba(0, 0, 0, 0.2) 50%,
                rgba(0, 0, 0, 0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 100;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }
        
        .screen-flicker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(51, 255, 51, 0.03);
            opacity: 0;
            pointer-events: none;
            z-index: 99;
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% { opacity: 0.01; }
            50% { opacity: 0.05; }
            100% { opacity: 0.01; }
        }

        /* --- MAIN LAYOUT --- */
        .terminal-container {
            width: 95%;
            height: 90%;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 60px 1fr;
            gap: 20px;
            box-shadow: 0 0 20px var(--dim-color), inset 0 0 20px var(--dim-color);
            position: relative;
            z-index: 10;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            grid-column: 1 / -1;
            border-bottom: 1px solid var(--dim-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px var(--main-color);
        }

        .header h1 { margin: 0; letter-spacing: 2px; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .blink { animation: blink 1s step-end infinite; }
        
        @keyframes blink { 50% { opacity: 0; } }

        /* --- BUTTONS SMALL --- */
        .btn-small {
            background: transparent;
            border: 1px solid var(--dim-color);
            color: var(--dim-color);
            font-family: var(--font-main);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .btn-small:hover {
            border-color: var(--main-color);
            color: var(--main-color);
            box-shadow: 0 0 5px var(--dim-color);
        }

        /* --- LEFT PANEL: STATS --- */
        .panel-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px dashed var(--dim-color);
            padding-right: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--dim-color) transparent;
        }

        .stat-group h3 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--dim-color);
            text-transform: uppercase;
            position: relative;
        }

        .bar-container {
            width: 100%;
            height: 20px;
            border: 1px solid var(--dim-color);
            padding: 2px;
            position: relative;
            background: #000;
        }

        .bar-fill {
            height: 100%;
            background-color: var(--main-color);
            width: 100%;
            transition: width 0.5s ease, background-color 0.3s;
            box-shadow: 0 0 5px var(--main-color);
        }

        .bar-fill.critical { background-color: var(--alert-color); box-shadow: 0 0 10px var(--alert-color); }
        
        .bar-fill.locked { 
            background-color: var(--disabled-color) !important; 
            box-shadow: none !important; 
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 20px);
            border-right: 2px solid var(--alert-color);
            opacity: 0.7;
        }
        
        .stat-value { position: absolute; right: 0; top: -18px; font-size: 0.8rem; }
        
        .stat-locked-msg { 
            position: absolute; 
            left: 0; 
            top: -20px;
            font-size: 0.8rem; 
            font-weight: bold;
            color: var(--alert-color); 
            background: #000;
            padding-right: 5px;
            display: none; 
            z-index: 5;
        }
        
        .stat-locked-msg.visible { 
            display: block; 
            animation: alert-blink 2s infinite;
        }

        @keyframes alert-blink {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px red; }
            50% { opacity: 0.5; text-shadow: none; }
        }

        /* --- CENTER PANEL: LOG --- */
        .panel-log {
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0; 
            height: 100%;
            overflow: hidden;
        }

        .log-output {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--dim-color);
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.4;
            background: rgba(0, 20, 0, 0.3);
            scrollbar-width: thin;
            scrollbar-color: var(--dim-color) transparent;
        }

        .log-output::-webkit-scrollbar { width: 8px; }
        .log-output::-webkit-scrollbar-track { background: #000; }
        .log-output::-webkit-scrollbar-thumb { background: var(--dim-color); border-radius: 4px; }

        .log-entry { margin-bottom: 15px; border-bottom: 1px dotted #1a401a; padding-bottom: 5px; }
        .log-entry.system { color: #88ff88; font-style: italic; }
        .log-entry.user { color: #fff; }
        .log-entry.horror { color: var(--alert-color); text-shadow: 1px 0 2px red; }
        .log-entry.dice { color: #ffff55; font-weight: bold; border-left: 3px solid #ffff55; padding-left: 10px; }
        .log-entry.cycle-penalty { color: #ffaa00; font-style: italic; opacity: 0.9; }
        .timestamp { color: var(--dim-color); font-size: 0.7rem; margin-right: 10px; }

        .journal-input-area {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        textarea {
            background: #000;
            border: 1px solid var(--main-color);
            color: var(--main-color);
            font-family: var(--font-main);
            padding: 10px;
            resize: none;
            height: 80px;
            outline: none;
        }

        textarea:focus { box-shadow: 0 0 10px var(--dim-color); }
        textarea::placeholder { color: var(--dim-color); }

        /* --- RIGHT PANEL: CARD & DIE --- */
        .panel-card {
            border-left: 1px dashed var(--dim-color);
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            overflow-y: auto;
        }

        .die-container {
            width: 60px;
            height: 60px;
            border: 2px solid var(--dim-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: #001100;
            color: #ffff55;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        .die-container.active {
            border-color: #ffff55;
            box-shadow: 0 0 15px #ffff55;
            text-shadow: 0 0 5px #ffff55;
        }

        .card-display {
            width: 100%;
            height: 280px;
            border: 2px solid var(--main-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            background: radial-gradient(circle, rgba(0,50,0,1) 0%, rgba(0,0,0,1) 100%);
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .card-suit { font-size: 4rem; margin-bottom: 10px; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid var(--main-color); width: 100%; padding-bottom: 5px;}
        .card-desc { font-size: 0.9rem; line-height: 1.3; }
        
        .deck-count {
            width: 100%;
            text-align: right;
            font-size: 0.8rem;
            color: var(--dim-color);
            margin-top: 5px;
        }

        .btn-action {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 2px solid var(--main-color);
            color: var(--main-color);
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-action:hover:not(:disabled) {
            background: var(--main-color);
            color: #000;
            box-shadow: 0 0 15px var(--main-color);
        }

        .btn-action:disabled {
            border-color: var(--dim-color);
            color: var(--dim-color);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-action.processing {
            background: rgba(51, 255, 51, 0.1);
            animation: pulse-green 1s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 var(--main-color); }
            50% { box-shadow: 0 0 15px var(--main-color); }
            100% { box-shadow: 0 0 0 var(--main-color); }
        }

        .btn-end {
            border-color: var(--alert-color);
            color: var(--alert-color);
            margin-top: 10px;
        }
        .btn-end:hover {
            background: var(--alert-color);
            color: white;
            box-shadow: 0 0 15px var(--alert-color);
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .terminal-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                overflow-y: auto;
                height: 100%;
                display: block;
            }
            .panel-stats, .panel-card, .panel-log {
                border: none;
                padding: 10px 0;
                margin-bottom: 20px;
                height: auto;
                min-height: auto;
            }
            .log-output { height: 200px; }
            .panel-card { border-left: none; border-top: 1px dashed var(--dim-color); padding-top: 20px; padding-left: 0; }
            .panel-stats { border-right: none; border-bottom: 1px dashed var(--dim-color); padding-bottom: 20px; padding-right: 0; }
        }

        /* UTILS */
        .suit-heart { color: #ff5555; text-shadow: 0 0 5px #ff0000; }
        .suit-diamond { color: #55ffff; text-shadow: 0 0 5px #00ffff; }
        .suit-club { color: #aa55ff; text-shadow: 0 0 5px #aa00ff; }
        .suit-spade { color: #55ff55; }
        
        /* MODAL COMMON */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        
        .modal.is-visible {
            display: flex;
        }

        .modal h2 { font-size: 3rem; margin-bottom: 20px; }
        .modal p { max-width: 600px; margin-bottom: 30px; font-size: 1.2rem; }

        /* DECK VIEWER IMPROVED STYLES */
        .deck-modal-content {
            width: 90%;
            height: 85%;
            background: #050a05;
            border: 2px solid var(--main-color);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .deck-grid {
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            padding-right: 10px;
            align-content: start;
            border-right: 1px solid var(--dim-color);
            scrollbar-width: thin;
            scrollbar-color: var(--dim-color) transparent;
        }

        .card-mini {
            border: 1px solid var(--dim-color);
            padding: 5px;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 20, 0, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            height: 80px;
        }

        .card-mini:hover {
            border-color: var(--main-color);
            box-shadow: 0 0 5px var(--main-color);
        }

        .card-mini.used {
            opacity: 0.4;
            background: #222;
            text-decoration: line-through;
            border-color: #444;
        }
        
        .card-mini.used:hover {
            opacity: 0.8;
            border-color: #666;
            box-shadow: none;
        }

        .card-mini-symbol { font-size: 1.5rem; }

        .deck-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--dim-color);
        }

        .modal-close-btn {
            grid-column: 1 / -1;
            margin-top: 10px;
            border: 1px solid var(--main-color);
            background: black;
            color: var(--main-color);
            padding: 10px 20px;
            cursor: pointer;
            width: 100%;
        }
        .modal-close-btn:hover { background: var(--main-color); color: black; }

        @media (max-width: 700px) {
            .deck-modal-content { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .deck-grid { border-right: none; border-bottom: 1px solid var(--dim-color); }
        }

    </style>
</head>
<body>

<div class="crt-overlay"></div>
<div class="screen-flicker"></div>

<div class="terminal-container">
    <!-- HEADER -->
    <div class="header">
        <div>GLACIAL_ECHO.EXE <span class="blink">_</span></div>
        <div class="header-controls">
            <button class="btn-small" onclick="game.showDeckViewer()">[VER DB]</button>
            <div id="turn-counter">CICLO: 00</div>
        </div>
    </div>

    <!-- LEFT: STATS (Reordered) -->
    <div class="panel-stats">
        <div class="stat-group">
            <h3>Estabilidad Mental (Ψ)</h3>
            <span class="stat-value" id="val-mental">100%</span>
            <div class="bar-container">
                <div class="bar-fill" id="bar-mental" style="width: 100%;"></div>
            </div>
        </div>

        <div class="stat-group">
            <h3>Soporte Vital (O₂)</h3>
            <span class="stat-value" id="val-life">100%</span>
            <div class="bar-container">
                <div class="bar-fill" id="bar-life" style="width: 100%;"></div>
            </div>
        </div>

        <hr style="border-color: var(--dim-color); border-style: dashed; width: 100%; opacity: 0.5;">

        <div class="stat-group">
            <h3>
                Señal S.O.S. 
                <span id="sos-locked-msg" class="stat-locked-msg">DESCONECTADO</span>
            </h3>
            <span class="stat-value" id="val-sos">0%</span>
            <div class="bar-container">
                <div class="bar-fill" id="bar-sos" style="width: 0%; background-color: #55ffff;"></div>
            </div>
        </div>

        <div class="stat-group">
            <h3>Firewall Sistema</h3>
            <span class="stat-value" id="val-firewall">0%</span>
            <div class="bar-container">
                <div class="bar-fill" id="bar-firewall" style="width: 0%; background-color: #ffaa00;"></div>
            </div>
        </div>

        <div class="stat-group">
            <h3>Análisis de Datos</h3>
            <span class="stat-value" id="val-analysis">0%</span>
            <div class="bar-container">
                <div class="bar-fill" id="bar-analysis" style="width: 0%; background-color: #aa55ff;"></div>
            </div>
        </div>
    </div>

    <!-- CENTER: LOG -->
    <div class="panel-log">
        <div class="log-output" id="log-output">
            <div class="log-entry system">
                <span class="timestamp">00:00:00</span>
                SISTEMA INICIADO. USUARIO: ANALISTA_7.<br>
                TEMPERATURA EXTERNA: -64°C.<br>
                ESTADO DE LA BASE: CRÍTICO/ABANDONADA.<br>
                INICIANDO PROCESO DE RECUPERACIÓN DE DATOS...<br>
                <br>
                > ESPERANDO LANZAMIENTO DE DADO PARA CALCULAR ANCHO DE BANDA...
            </div>
        </div>
        
        <div class="journal-input-area">
            <textarea id="journal-input" placeholder="Escribe tu entrada de bitácora aquí..."></textarea>
        </div>
    </div>

    <!-- RIGHT: CARD & ACTIONS -->
    <div class="panel-card">
        <div class="deck-count">BLOQUES DE DATOS: <span id="deck-size">52</span></div>
        
        <div class="die-container" id="die-display">-</div>

        <div class="card-display" id="card-display">
            <div style="opacity: 0.5;">SISTEMA EN ESPERA</div>
        </div>

        <div style="width: 100%;">
            <button class="btn-action" id="btn-draw" onclick="game.nextAction()">INICIAR CICLO (LANZAR DADO)</button>
            <button class="btn-action btn-end" id="btn-finish" onclick="game.attemptFinish()">FINALIZAR SESIÓN</button>
        </div>
    </div>
</div>

<!-- GAME OVER MODAL -->
<div id="game-over-modal" class="modal">
    <h2 id="modal-title">CONEXIÓN PERDIDA</h2>
    <p id="modal-desc">La señal se ha perdido en la estática.</p>
    <button class="btn-action" onclick="location.reload()" style="max-width: 200px;">REINICIAR SISTEMA</button>
</div>

<!-- DECK VIEWER MODAL IMPROVED -->
<div id="deck-modal" class="modal" style="background: rgba(0,0,0,0.95); z-index: 300;">
    <div class="deck-modal-content">
        <div class="deck-grid" id="deck-grid">
            <!-- Grid of cards -->
        </div>
        <div class="deck-details" id="deck-details">
            <div style="opacity: 0.5;">SELECCIONA UN BLOQUE DE DATOS PARA VER DETALLES</div>
        </div>
        <button class="modal-close-btn" onclick="game.closeDeckViewer()">CERRAR BASE DE DATOS</button>
    </div>
</div>

<script>
    /* --- LÓGICA DEL JUEGO --- */

    const SUITS = {
        HEARTS: { symbol: '♥', type: 'introspection', color: 'suit-heart', label: "MENTAL" },
        DIAMONDS: { symbol: '♦', type: 'base', color: 'suit-diamond', label: "SOPORTE" },
        CLUBS: { symbol: '♣', type: 'threat', color: 'suit-club', label: "AMENAZA" },
        SPADES: { symbol: '♠', type: 'work', color: 'suit-spade', label: "DATOS" }
    };

    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // BASE DE DATOS DE CARTAS
    const CARD_TEMPLATES = {
        HEARTS: [
            "Encuentro una foto arrugada bajo el teclado. Son ellos. Casi había olvidado sus caras.",
            "El zumbido de los servidores se detiene por un segundo. Silencio absoluto. Paz.",
            "Me miro en el reflejo negro del monitor. Aún soy yo. Creo que aún soy yo.",
            "Recuerdo mi primer día en la academia. Todo parecía tan ordenado entonces.",
            "Cierro los ojos. Imagino el calor del sol en la playa de Viedma.",
            "Un momento de lucidez entre la estática. Sé por qué estoy aquí.",
            "Sueño despierto con una taza de café caliente. Casi puedo olerlo.",
            "Escribo una carta mental a mi familia. No la enviaré, pero ayuda.",
            "Releo mis notas antiguas. Mi caligrafía era más firme hace una semana.",
            "La luz parpadea rítmicamente. Es casi hipnótico, calmante.",
            "Encuentro un viejo MP3 en un cajón. Funciona. Una canción de rock nacional suena.",
            "Me doy cuenta de que he sobrevivido hasta ahora. Soy más fuerte de lo que pensaba.",
            "Limpio mi estación de trabajo. El orden físico trae orden mental."
        ],
        DIAMONDS: [
            "La calefacción emite un chirrido metálico. La temperatura baja 2 grados.",
            "Encuentro una ración de emergencia olvidada en la despensa. Sabe a cartón, pero nutre.",
            "Una tubería estalla en el pasillo B. Agua helada por todas partes.",
            "El generador auxiliar tose. Las luces se atenúan peligrosamente.",
            "Descubro una botella de whisky medio llena en el despacho del Comandante.",
            "Ventisca exterior. El viento golpea las paredes como un gigante furioso.",
            "Fallo en los filtros de aire. El ambiente se siente viciado y pesado.",
            "Encuentro un kit médico básico. Vendas y aspirinas.",
            "La cafetera vuelve a funcionar milagrosamente. Néctar negro.",
            "Una ventana del sector 4 se agrieta. Debo sellarla con cinta aislante.",
            "Cortocircuito en el panel de control. Chispas y olor a ozono.",
            "Logro redirigir energía de los laboratorios vacíos a los calefactores.",
            "El traje térmico tiene un rasgadura. El frío se cuela como agujas."
        ],
        CLUBS: [
            "La pantalla muestra mi nombre repetido mil veces. Yo no lo escribí.",
            "Oigo golpes dentro de los conductos de ventilación. Algo grande se arrastra.",
            "Sangrado nasal repentino. La sangre cae sobre las teclas formando patrones.",
            "Las sombras en la esquina de la habitación tienen la geometría incorrecta.",
            "Una voz susurra desde los altavoces apagados: 'Abre la puerta'.",
            "Veo a un compañero caminando por el pasillo. Estoy solo en la base.",
            "El código en la pantalla se reorganiza formando una cara que grita.",
            "Siento que algo respira en mi nuca. No me atrevo a voltear.",
            "Todos los relojes de la base se detienen a la vez.",
            "Mis manos no me obedecen por un minuto. Escriben solas: NO ERES TÚ.",
            "Alucinación auditiva: el sonido de olas rompiendo, pero son olas de estática.",
            "La temperatura no baja, pero siento un frío que quema los huesos. Es la Señal.",
            "Pesadilla despierto: la habitación se estira infinitamente."
        ],
        SPADES: [
            "Logro desencriptar el log del día 45. Los datos fluyen.",
            "Restablezco la conexión con el satélite durante 30 segundos. Señal enviada.",
            "El algoritmo de compresión funciona. Bloque de datos asegurado.",
            "Limpio un sector corrupto del disco duro. El Firewall se fortalece.",
            "Analizo las muestras de audio. Hay un patrón inteligente en el ruido.",
            "Hackeo el terminal del supervisor. Acceso a subrutinas de seguridad.",
            "Compilación exitosa. El sistema responde más rápido.",
            "Reinicio los protocolos de comunicación de emergencia.",
            "Aíslo el virus que causó el colapso inicial.",
            "Descifro las coordenadas de origen de la Señal. No viene de la Tierra.",
            "Optimizo el consumo de energía del transmisor.",
            "Recupero la bitácora de video final del equipo anterior.",
            "Ejecuto el protocolo 'Caja Negra'. Los datos están listos para envío."
        ]
    };

    class Game {
        constructor() {
            this.state = {
                mental: 100,
                life: 100,
                sos: 0,
                firewall: 0,
                analysis: 0,
                turn: 0,
                gameOver: false,
                cardsPending: 0,
                sosLocked: false
            };
            this.deck = [];
            this.allCards = []; // Master list for DB viewer
            this.log = document.getElementById('log-output');
            this.input = document.getElementById('journal-input');
            this.dieDisplay = document.getElementById('die-display');
            this.btnDraw = document.getElementById('btn-draw');
            
            this.initDeck();
            this.updateUI();
        }

        initDeck() {
            // Crear 52 cartas
            const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            const suits = [
                { s: SUITS.HEARTS, t: CARD_TEMPLATES.HEARTS, eFn: (s) => { const h = rand(5,15); s.mental=Math.min(100, s.mental+h); return `Recuperas ${h}% de Estabilidad Mental.`; }},
                { s: SUITS.DIAMONDS, t: CARD_TEMPLATES.DIAMONDS, eFn: (s) => { 
                    const good = Math.random()>0.4; 
                    if(good){const h=rand(5,10); s.life=Math.min(100,s.life+h); return `Soporte Vital aumenta ${h}%.`;}
                    else{const d=rand(5,15); s.life=Math.max(0,s.life-d); return `Soporte Vital cae ${d}%.`;} 
                }},
                { s: SUITS.CLUBS, t: CARD_TEMPLATES.CLUBS, eFn: (s) => { const d=rand(8,20); s.mental=Math.max(0,s.mental-d); return `Estabilidad Mental cae ${d}%.`; }},
                { s: SUITS.SPADES, t: CARD_TEMPLATES.SPADES, eFn: (s) => {
                    const r = Math.random(); const a = rand(10,20);
                    if(r<0.33){ if(s.sosLocked)return `ERROR: Antena destruida. SOS fallido.`; s.sos=Math.min(100,s.sos+a); return `Progreso SOS: +${a}%.`;}
                    else if(r<0.66){ s.firewall=Math.min(100,s.firewall+a); return `Progreso Firewall: +${a}%.`;}
                    else { s.analysis=Math.min(100,s.analysis+a); return `Progreso Análisis: +${a}%.`;}
                }}
            ];

            let id = 0;
            suits.forEach(group => {
                ranks.forEach((r, i) => {
                    const card = {
                        id: id++,
                        suit: group.s,
                        rank: r,
                        text: group.t[i],
                        effect: group.eFn,
                        drawn: false // Track status
                    };
                    this.deck.push(card);
                    this.allCards.push(card);
                });
            });

            // Barajar (Fisher-Yates)
            for (let i = this.deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
            }
        }

        logEntry(text, type = 'system') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('es-ES');
            div.innerHTML = `<span class="timestamp">${time}</span> ${text}`;
            this.log.appendChild(div);
            this.log.scrollTop = this.log.scrollHeight;
        }

        // LÓGICA PRINCIPAL DEL BOTÓN
        nextAction() {
            if (this.state.gameOver) return;

            const userText = this.input.value.trim();
            if (userText) {
                this.logEntry(userText, 'user');
                this.input.value = '';
            }

            if (this.state.cardsPending <= 0) {
                this.rollDie();
            } else {
                this.drawCard();
            }
        }

        rollDie() {
            if (this.deck.length === 0) {
                this.finishGame("deck_empty");
                return;
            }

            if (this.state.turn > 0) {
                const mentalPenalty = rand(3, 6);
                const lifePenalty = rand(2, 5);
                
                this.state.mental = Math.max(0, this.state.mental - mentalPenalty);
                this.state.life = Math.max(0, this.state.life - lifePenalty);

                this.logEntry(`FIN DE CICLO ${this.state.turn}: El tiempo pasa. Frío: -${lifePenalty}% O₂ | Aislamiento: -${mentalPenalty}% Ψ`, 'cycle-penalty');

                if (this.state.mental <= 0) { this.finishGame("insanity"); return; }
                if (this.state.life <= 0) { this.finishGame("frozen"); return; }
            }

            const roll = rand(1, 6);
            this.state.turn++; 
            this.state.cardsPending = roll;

            // --- EVENTO ESPECIAL CICLO 6 ---
            if (this.state.turn === 6) {
                this.state.sosLocked = true;
                this.logEntry("¡ALERTA DE TORMENTA! Los sensores detectan vientos cataclísmicos. La antena de comunicaciones ha sido arrancada de la base.", "horror");
                this.logEntry("SISTEMA: Módulo de Transmisión SOS [OFFLINE]. Ya no es posible pedir ayuda externa.", "system");
                this.logEntry(">> ADVERTENCIA: RANGO DE EXTRACCIÓN EXCEDIDO. El vehículo de rescate ha abandonado el sector.", "horror");
            }

            this.dieDisplay.innerText = roll;
            this.dieDisplay.classList.add('active');
            setTimeout(() => this.dieDisplay.classList.remove('active'), 500);

            this.logEntry(`CICLO ${this.state.turn} INICIADO. RESULTADO DADO: [${roll}]`, 'dice');
            this.logEntry(`> Se deben procesar ${roll} bloques de datos...`, 'system');

            this.updateUI();
        }

        drawCard() {
            if (this.deck.length === 0) {
                this.finishGame("deck_empty");
                return;
            }

            const card = this.deck.pop();
            card.drawn = true; // Mark as drawn for DB viewer
            this.state.cardsPending--;

            const effectResult = card.effect(this.state);

            this.updateCardDisplay(card, effectResult);
            
            // UPDATE DIE DISPLAY COUNTDOWN
            if (this.state.cardsPending <= 0) {
                this.dieDisplay.innerText = "-";
            } else {
                this.dieDisplay.innerText = this.state.cardsPending;
            }

            this.logEntry(`> DATOS ENTRANTES [${card.suit.symbol}${card.rank}]: ${card.text}`, card.suit.type === 'threat' ? 'horror' : 'system');
            this.logEntry(`> SISTEMA: ${effectResult}`, 'system');

            if (this.state.mental <= 0) {
                this.finishGame("insanity");
                return;
            }
            else if (this.state.life <= 0) {
                this.finishGame("frozen");
                return;
            }
            
            this.updateUI();
        }

        updateCardDisplay(card, resultText) {
            const display = document.getElementById('card-display');
            display.innerHTML = `
                <div class="card-suit ${card.suit.color}">${card.suit.symbol}</div>
                <div class="card-title ${card.suit.color}">ARCHIVO: ${card.rank}</div>
                <div class="card-desc">${card.text}</div>
                <div class="card-desc" style="margin-top:15px; color: #fff; font-size: 0.8rem;">EFECTO: ${resultText}</div>
            `;
            
            if (card.suit.type === 'threat') {
                document.querySelector('.terminal-container').style.boxShadow = "0 0 20px #ff0000, inset 0 0 20px #ff0000";
                setTimeout(() => {
                    document.querySelector('.terminal-container').style.boxShadow = "";
                }, 300);
            }
        }

        updateUI() {
            document.getElementById('val-mental').innerText = this.state.mental + '%';
            document.getElementById('bar-mental').style.width = this.state.mental + '%';
            document.getElementById('bar-mental').className = `bar-fill ${this.state.mental < 30 ? 'critical' : ''}`;

            document.getElementById('val-life').innerText = this.state.life + '%';
            document.getElementById('bar-life').style.width = this.state.life + '%';
            document.getElementById('bar-life').className = `bar-fill ${this.state.life < 30 ? 'critical' : ''}`;

            // SOS UI Logic
            const sosBar = document.getElementById('bar-sos');
            const sosVal = document.getElementById('val-sos');
            
            if (this.state.sosLocked) {
                sosBar.style.backgroundColor = '';
                sosBar.className = 'bar-fill locked';
                sosBar.style.width = '100%'; 
                
                document.getElementById('sos-locked-msg').classList.add('visible');
                sosVal.innerText = "OFFLINE";
                sosVal.style.color = "var(--alert-color)";
                sosVal.style.fontWeight = "bold";
            } else {
                sosBar.className = 'bar-fill';
                sosBar.style.backgroundColor = '#55ffff';
                sosVal.innerText = this.state.sos + '%';
                sosVal.style.color = "var(--main-color)";
                sosBar.style.width = this.state.sos + '%';
            }

            document.getElementById('val-firewall').innerText = this.state.firewall + '%';
            document.getElementById('bar-firewall').style.width = this.state.firewall + '%';

            document.getElementById('val-analysis').innerText = this.state.analysis + '%';
            document.getElementById('bar-analysis').style.width = this.state.analysis + '%';

            document.getElementById('turn-counter').innerText = `CICLO: ${this.state.turn.toString().padStart(2, '0')}`;
            document.getElementById('deck-size').innerText = this.deck.length;

            if (this.state.cardsPending > 0) {
                this.btnDraw.innerText = `PROCESAR DATO (RESTANTES: ${this.state.cardsPending})`;
                this.btnDraw.classList.add('processing');
                document.getElementById('btn-finish').disabled = true;
                document.getElementById('btn-finish').title = "Completa el ciclo actual primero";
            } else {
                this.btnDraw.innerText = `INICIAR CICLO (LANZAR DADO)`;
                this.btnDraw.classList.remove('processing');
                
                const btnEnd = document.getElementById('btn-finish');
                const canFinish = (this.state.sos > 50 && !this.state.sosLocked) || this.state.firewall > 50 || this.state.analysis > 50;
                
                if (canFinish) {
                    btnEnd.disabled = false;
                    btnEnd.style.opacity = "1";
                    btnEnd.title = "";
                } else {
                    btnEnd.disabled = true;
                    btnEnd.style.opacity = "0.3";
                }
            }
        }

        /* --- DECK VIEWER IMPROVED LOGIC --- */
        showDeckViewer() {
            const grid = document.getElementById('deck-grid');
            const details = document.getElementById('deck-details');
            grid.innerHTML = '';
            
            // Reset details view
            details.innerHTML = '<div style="opacity: 0.5;">SELECCIONA UN BLOQUE DE DATOS PARA VER DETALLES</div>';

            // Use allCards to show everything
            const sortedDeck = [...this.allCards].sort((a, b) => {
                // Sort by Suit label then Rank
                if (a.suit.label !== b.suit.label) return a.suit.label.localeCompare(b.suit.label);
                return 0; // Keeping original generation order for ranks usually works fine (2,3,4...)
            });

            sortedDeck.forEach(card => {
                const el = document.createElement('div');
                el.className = `card-mini ${card.drawn ? 'used' : ''}`;
                el.innerHTML = `
                    <div class="card-mini-symbol ${card.suit.color}">${card.suit.symbol}</div>
                    <div style="font-weight:bold;">${card.rank}</div>
                `;
                
                // Click to view details
                el.onclick = () => {
                    // Generate a "fake" state for previewing effect description
                    // Note: Effect functions might mutate state, we just want description.
                    // To be safe, we reconstruct the generic effect description or just show text.
                    // For now, let's show the static text.
                    
                    let status = card.drawn ? "<span style='color:red'>[PROCESADO/AGOTADO]</span>" : "<span style='color:#33ff33'>[ACTIVO/DISPONIBLE]</span>";

                    details.innerHTML = `
                        <div class="card-suit ${card.suit.color}" style="font-size:3rem">${card.suit.symbol}</div>
                        <h3 style="color:white; border-bottom:1px solid #33ff33; padding-bottom:5px; width:100%">ARCHIVO ${card.rank}</h3>
                        <div style="margin: 10px 0; font-size: 0.8rem; color: #888;">TIPO: ${card.suit.label}</div>
                        <div style="margin: 15px 0; font-style: italic;">"${card.text}"</div>
                        <div style="margin-top: 20px; font-size: 0.9rem;">${status}</div>
                    `;
                };

                grid.appendChild(el);
            });
            
            document.getElementById('deck-modal').classList.add('is-visible');
        }

        closeDeckViewer() {
            document.getElementById('deck-modal').classList.remove('is-visible');
        }

        attemptFinish() {
            if (confirm("¿Estás seguro de finalizar la sesión? El sistema calculará tus probabilidades de supervivencia.")) {
                this.finishGame("manual");
            }
        }

        finishGame(reason) {
            this.state.gameOver = true;
            const modal = document.getElementById('game-over-modal');
            const mTitle = document.getElementById('modal-title');
            const mDesc = document.getElementById('modal-desc');
            
            modal.classList.add('is-visible');

            if (reason === "insanity") {
                mTitle.innerText = "ERROR FATAL: MENTE CORRUPTA";
                mTitle.style.color = "red";
                mDesc.innerHTML = "La Señal ha reescrito tus neuronas. Ahora eres parte de la transmisión.<br><br><b>FINAL: PERDIDO EN LA ESTÁTICA</b>";
            } else if (reason === "frozen") {
                mTitle.innerText = "SISTEMAS VITALES: OFF";
                mTitle.style.color = "#00ffff";
                mDesc.innerHTML = "El frío ganó. Tu cuerpo es encontrado meses después.<br><br><b>FINAL: ESTATUA DE HIELO</b>";
            } else {
                let endings = [];
                if (this.state.sos >= 80 && !this.state.sosLocked) endings.push("RESCATE");
                if (this.state.firewall >= 80) endings.push("HÉROE");
                if (this.state.analysis >= 80) endings.push("ERUDITO");

                if (endings.length === 3) {
                    mTitle.innerText = "EJECUCIÓN PERFECTA";
                    mTitle.style.color = "#33ff33";
                    mDesc.innerHTML = "Has logrado lo imposible. Señal contenida, datos asegurados, rescate en camino.<br><br><b>RANGO: S+</b>";
                } else if (endings.includes("RESCATE")) {
                    mTitle.innerText = "EXTRACCIÓN CONFIRMADA";
                    mDesc.innerHTML = "El equipo de rescate te saca de allí justo a tiempo.<br><br><b>FINAL A: SUPERVIVIENTE</b>";
                } else if (endings.includes("HÉROE")) {
                    mTitle.innerText = "PROTOCOLO DE CONTENCIÓN";
                    mDesc.innerHTML = "No pudiste pedir ayuda a tiempo, pero el Firewall es impenetrable.<br><br><b>FINAL B: EL GUARDIÁN</b>";
                } else if (endings.includes("ERUDITO")) {
                    mTitle.innerText = "TRANSMISIÓN COMPLETADA";
                    mDesc.innerHTML = "Tu cuerpo falla, pero los datos han sido enviados a la nube.<br><br><b>FINAL C: EL LEGADO</b>";
                } else {
                    mTitle.innerText = "MISIÓN FALLIDA";
                    mTitle.style.color = "gray";
                    mDesc.innerHTML = "Te quedaste sin recursos o datos. Nadie sabrá qué pasó aquí.<br><br><b>FINAL: DESAPARECIDO</b>";
                }
            }
        }
    }

    // Iniciar juego
    const game = new Game();

</script>
</body>
</html>